<template>
  <MistralHeader />

  <MistralHomeLayout>
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <template #posts>
      <!-- â‘  Hero -->
      <section
        class="hero-section bg-white rounded-2xl border border-[rgba(50,93,206,0.05)] p-6 md:p-10 flex flex-col gap-6 md:flex-row md:items-center mt-10 mb-10 relative overflow-hidden"
      >
        <img
          src="/images/mv.webp"
          alt="Hero Background"
          class="absolute inset-0 z-0 w-full h-full object-cover"
          loading="eager"
        />
        <div class="flex-1 relative z-10">
          <p class="inline-flex items-center px-2 py-1 mb-3 text-xs font-semibold rounded-full bg-white text-[color:var(--brand)] border border-[rgba(50,93,206,0.16)]">
            LicenceHubï½œç™»éŒ²è²©å£²è€…ã®æƒ…å ±ã‚¬ã‚¤ãƒ‰
          </p>

          <h1 class="text-3xl md:text-4xl font-bold text-[color:var(--heading)] mb-4 leading-tight">
            ç™»éŒ²è²©å£²è€…ã‚’ã‚ã–ã™ã‚ãªãŸã¸ã€‚<br class="hidden md:block" />
            å‹‰å¼·ãƒ»åˆæ ¼ãƒ»ä»•äº‹æ¢ã—ã‚’ã€ã“ã®ä¸€ã¤ã«ã€‚
          </h1>

          <p class="text-[15px] md:text-lg text-[color:var(--heading)] mb-5">
            è©¦é¨“å¯¾ç­–ãƒ»æ•™ææ¯”è¼ƒãƒ»ç¾å ´ã§ã®åƒãæ–¹ã¾ã§ã€ç™»éŒ²è²©å£²è€…ã«é–¢ã™ã‚‹æƒ…å ±ã‚’ç™ºä¿¡ã—ã¦ã„ã¾ã™ã€‚
          </p>

          <div class="flex flex-wrap gap-3">
            <NuxtLink
              to="/licenses/tohan/exam"
              class="inline-flex items-center rounded-full px-4 py-2 text-sm font-semibold bg-white text-[color:var(--brand)] border border-[rgba(50,93,206,0.25)] hover:bg-[color:var(--brand)] hover:text-white transition"
            >
              å‹‰å¼·ã®å§‹ã‚æ–¹ã‚’è¦‹ã‚‹
            </NuxtLink>
            <NuxtLink
              to="/licenses/tohan/materials"
              class="inline-flex items-center rounded-full px-4 py-2 text-sm font-semibold bg-white text-[color:var(--brand)] border border-[rgba(50,93,206,0.25)] hover:bg-[color:var(--brand)] hover:text-white transition"
            >
              é€šä¿¡è¬›åº§ãƒ»æ•™æã‚’æ¯”è¼ƒã™ã‚‹
            </NuxtLink>
          </div>
        </div>
      </section>

      <!-- â‘¡ ã‚«ãƒ†ã‚´ãƒªã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ³ã‚¯ -->
      <section class="mb-12">
        <h2 class="section-title mb-3">ã¾ãšã¯ã“ã“ã‹ã‚‰</h2>
        <p class="text-xs text-[color:var(--text-muted)] mb-4">
          å‹‰å¼·ãƒ»æ•™æãƒ»ä»•äº‹ã®3ã¤ã®å…¥ã‚Šå£ã‹ã‚‰ã€ç›®çš„ã«åˆã‚ã›ã¦æƒ…å ±ã‚’æ¢ã›ã¾ã™ã€‚
        </p>
        <div class="grid gap-4 md:grid-cols-3">
          <NuxtLink
            v-for="item in quickLinks"
            :key="item.to"
            :to="item.to"
            class="group bg-white rounded-xl border border-[rgba(15,23,42,0.03)] shadow-sm p-4 flex items-center gap-3 transition"
          >
            <div
              class="w-10 h-10 rounded-full bg-[rgba(50,93,206,0.08)] flex items-center justify-center text-[color:var(--brand)] text-lg"
            >
              {{ item.icon }}
            </div>
            <div>
              <p class="font-semibold text-[color:var(--heading)] text-sm group-hover:text-[color:var(--brand)] transition-colors">{{ item.title }}</p>
              <p class="text-xs text-[color:var(--text-muted)] group-hover:text-[color:var(--brand)] transition-colors">{{ item.desc }}</p>
            </div>
          </NuxtLink>
        </div>
      </section>


      <!-- â‘¢ æ–°ç€è¨˜äº‹ï¼ˆã“ã“ã«å…ƒã® Mistral ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å…¥ã‚Œã¦ã‚‚ã„ã„ï¼‰ -->
      <section class="mb-12">
        <div class="flex items-center justify-between mb-4">
          <h2 class="section-title mb-0">æ–°ç€è¨˜äº‹</h2>
          <NuxtLink to="/licenses/tohan/articles" class="text-sm text-[color:var(--brand)] hover:underline">ã‚‚ã£ã¨è¦‹ã‚‹</NuxtLink>
        </div>

        <!-- æ–°ç€è¨˜äº‹ -->
        <div v-if="latestPosts.length > 0" class="grid gap-6 md:grid-cols-3">
          <NuxtLink
            v-for="post in latestPosts"
            :key="post._path"
            :to="post._path"
            class="group bg-white rounded-xl border border-[rgba(15,23,42,0.02)] shadow-sm overflow-hidden flex flex-col transition"
          >
            <div v-if="post.cover" class="h-32 bg-slate-100 flex items-center justify-center text-slate-400 text-sm">
              <img
                :src="'/images/' + post.cover"
                :alt="post.title"
                class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-[1.02]"
                width="360"
                height="192"
                sizes="(max-width: 768px) 100vw, 360px"
                loading="lazy"
                decoding="async"
              />
            </div>
            <div v-else class="h-32 bg-slate-100 flex items-center justify-center text-slate-400 text-sm">
              no image
            </div>
            <div class="p-4 flex flex-col gap-3 flex-1">
              <p
                v-if="post.tags && post.tags.length"
                class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-[rgba(50,93,206,0.08)] text-[0.6rem] text-[color:var(--brand)] font-semibold w-fit"
              >
                {{ post.tags[0] }}
              </p>
              <p class="font-semibold text-[color:var(--heading)] leading-snug line-clamp-2 group-hover:text-[color:var(--brand)] transition-colors">
                {{ post.title }}
              </p>
              <p v-if="post.date" class="text-xs text-[color:var(--text-muted)] mt-auto">
                {{ formatDate(post.date) }}
              </p>
            </div>
          </NuxtLink>
        </div>
        <div v-else class="text-center text-[color:var(--text-muted)] py-8">
          è¨˜äº‹ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“
        </div>
      </section>

      <!-- â‘£ ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="space-y-12 mb-4">
        <div v-for="section in categorySections" :key="section.slug">
          <div class="flex items-center justify-between mb-4">
            <h2 class="section-title mb-0">{{ section.title }}</h2>
            <NuxtLink :to="section.to" class="text-sm text-[color:var(--brand)] hover:underline">
              ã‚‚ã£ã¨è¦‹ã‚‹
            </NuxtLink>
          </div>

          <div v-if="section.items.length > 0" class="grid gap-6 md:grid-cols-3">
            <NuxtLink
              v-for="post in section.items"
              :key="post._path"
              :to="post._path"
              class="group bg-white rounded-xl border border-[rgba(15,23,42,0.02)] shadow-sm overflow-hidden flex flex-col transition"
            >
              <!-- ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆæ–°ç€ã¨åŒã˜ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ -->
              <div v-if="post.cover" class="h-32 bg-slate-100 flex items-center justify-center text-slate-400 text-sm">
                <img
                  :src="'/images/' + post.cover"
                  :alt="post.title"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-[1.02]"
                  width="360"
                  height="192"
                  sizes="(max-width: 768px) 100vw, 360px"
                  loading="lazy"
                  decoding="async"
                />
              </div>
              <div v-else class="h-32 bg-slate-100 flex items-center justify-center text-slate-400 text-sm">
                no image
              </div>

              <!-- ãƒ†ã‚­ã‚¹ãƒˆéƒ¨ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‹ä»»æ„ã§èª¬æ˜ï¼‹æ—¥ä»˜ï¼‰ -->
              <div class="p-4 flex flex-col gap-3 flex-1">
                <p v-if="post.date" class="text-xs text-[color:var(--text-muted)]">
                  {{ formatDate(post.date) }}
                </p>
                <p class="font-semibold text-[color:var(--heading)] leading-snug line-clamp-2 group-hover:text-[color:var(--brand)] transition-colors">
                  {{ post.title }}
                </p>
                <p
                  v-if="post.description"
                  class="text-xs text-[color:var(--text-muted)] leading-snug line-clamp-2"
                >
                  {{ post.description }}
                </p>
              </div>
            </NuxtLink>
          </div>

          <div v-else class="text-center text-[color:var(--text-muted)] py-4 text-sm">
            è©²å½“ã™ã‚‹è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>
      </section>

    </template>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <template #sidebar>
      <MistralSidebar :tags="tags" />
    </template>
  </MistralHomeLayout>

  <MistralFooter />
</template>
  
<script setup lang="ts">
import MistralHeader from '~/components/themes/mistral/MistralHeader.vue'
import MistralFooter from '~/components/themes/mistral/MistralFooter.vue'
import MistralHomeLayout from '~/components/content/MistralHomeLayout.vue'
import MistralSidebar from '~/components/themes/mistral/MistralSidebar.vue'
import FloatingIconsBackground from '~/components/themes/mistral/FloatingIconsBackground.vue'

const appConfig = useAppConfig()
const route = useRoute()

useSeoMeta({
  title: appConfig.site.ogTitle,
  description: appConfig.site.ogDescription,
  ogTitle: appConfig.site.ogTitle,
  ogDescription: appConfig.site.ogDescription,
  ogUrl: appConfig.site.ogUrl,
  ogType: () => appConfig.site.ogType as any,
  ogLocale: appConfig.site.ogLocale,
  ogSiteName: appConfig.site.ogSiteName,
  ogImage: appConfig.site.ogImage,
  ogImageWidth: appConfig.site.ogImageWidth,
  ogImageHeight: appConfig.site.ogImageHeight,
  ogImageAlt: appConfig.site.ogImageAlt,
  twitterCard: 'summary_large_image',
  keywords:
    'ç™»éŒ²è²©å£²è€…, ç™»éŒ²è²©å£²è€… è©¦é¨“, ç™»éŒ²è²©å£²è€… å‹‰å¼·, ç™»éŒ²è²©å£²è€… ç‹¬å­¦, ç™»éŒ²è²©å£²è€… é€šä¿¡è¬›åº§, ç™»éŒ²è²©å£²è€… å‹‰å¼·æ³•, ç™»éŒ²è²©å£²è€… ä»•äº‹å†…å®¹, ç™»éŒ²è²©å£²è€… ä»•äº‹ãƒ»è»¢è·',
})

useHead({
  htmlAttrs: {
    lang: 'ja',
  },
  link: [
    {
      rel: 'canonical',
      href: `${appConfig.site.domain}${route.path}`,
    },
  ],
})

const quickLinks = [
  { to: '/licenses/tohan/exam', title: 'å—é¨“å¯¾ç­–', desc: 'åˆæ ¼ã«å¿…è¦ãªç¯„å›²ã‚’æ•´ç†', icon: 'ğŸ“˜' },
  { to: '/licenses/tohan/materials', title: 'æ•™æãƒ»è¬›åº§æ¯”è¼ƒ', desc: 'é€šä¿¡è¬›åº§ãƒ»ç‹¬å­¦ãƒ†ã‚­ã‚¹ãƒˆ', icon: 'ğŸ“š' },
  { to: '/licenses/tohan/work', title: 'ä»•äº‹ãƒ»è»¢è·', desc: 'ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢ãƒ»èª¿å‰¤è–¬å±€', icon: 'ğŸ’¼' },
]

// å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰å–å¾—
const { data: allPosts } = await useAsyncData('home-posts', async () => {
  try {
    console.log('[home.vue] Fetching posts from content...')
    const posts = await queryContent()
      .only(['title', 'description', 'date', 'tags', '_path', 'cover', 'listed'])
      .find()
    
    console.log('[home.vue] Total posts found:', posts.length)
    console.log('[home.vue] Post paths:', posts.map((p: any) => p._path))
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆ
    const filtered = posts
      .filter((p: any) => {
        // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¯é™¤å¤–
        if (p._path === '/' || p._path === '/index') return false
        // listedãŒæ˜ç¤ºçš„ã«falseã®ã‚‚ã®ã¯é™¤å¤–
        if (p.listed === false) return false
        // dateãŒã‚ã‚‹ã‚‚ã®ã®ã¿
        return !!p.date
      })
      .sort((a: any, b: any) => {
        const dateA = new Date(a.date).getTime()
        const dateB = new Date(b.date).getTime()
        return dateB - dateA
      })
      .slice(0, 10)
    
    console.log('[home.vue] Filtered posts:', filtered.length)
    console.log('[home.vue] Filtered paths:', filtered.map((p: any) => p._path))
    
    return filtered
  } catch (error: any) {
    console.error('[home.vue] Error fetching posts:', error)
    if (error.statusCode === 404) {
      console.error('[home.vue] 404 Error - Document not found!')
      console.error('[home.vue] Query that caused 404:', error.data?.query)
    }
    console.error('[home.vue] Error details:', JSON.stringify(error, null, 2))
    console.error('[home.vue] Error stack:', error.stack)
    return []
  }
})

const latestPosts = computed(() => {
  return (allPosts.value || []).slice(0, 3)
})

const categorySections = computed(() => {
  const posts = allPosts.value || []
  return [
    {
      slug: 'exam',
      title: 'å—é¨“å¯¾ç­–',
      to: '/licenses/tohan/exam',
      items: posts.filter((p: any) => 
        p.tags?.includes('è©¦é¨“æƒ…å ±') || p._path?.startsWith('/licenses/tohan/exam')
      ).slice(0, 3),
    },
    {
      slug: 'materials',
      title: 'æ•™æãƒ»é€šä¿¡è¬›åº§',
      to: '/licenses/tohan/materials',
      items: posts.filter((p: any) => 
        p.tags?.some((tag: string) => ['æ•™æ', 'é€šä¿¡è¬›åº§', 'ãƒ¬ãƒ“ãƒ¥ãƒ¼'].includes(tag)) || 
        p._path?.startsWith('/licenses/tohan/materials')
      ).slice(0, 3),
    },
    {
      slug: 'work',
      title: 'ä»•äº‹ãƒ»è»¢è·',
      to: '/licenses/tohan/work',
      items: posts.filter((p: any) => 
        p.tags?.some((tag: string) => ['ä»•äº‹', 'è»¢è·'].includes(tag)) || 
        p._path?.startsWith('/licenses/tohan/work')
      ).slice(0, 3),
    },
  ]
})

// ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—
const { data: allTags } = await useAsyncData('home-tags', async () => {
  try {
    console.log('[home.vue] Fetching tags from content...')
    const posts = await queryContent()
      .only(['tags'])
      .find()
    
    console.log('[home.vue] Total posts for tags:', posts.length)
    
    const tagSet = new Set<string>()
    posts.forEach((post: any) => {
      if (Array.isArray(post.tags)) {
        post.tags.forEach((tag: string) => tagSet.add(tag))
      }
    })
    const tags = Array.from(tagSet).slice(0, 6)
    console.log('[home.vue] Extracted tags:', tags)
    return tags
  } catch (error: any) {
    console.error('[home.vue] Error fetching tags:', error)
    if (error.statusCode === 404) {
      console.error('[home.vue] 404 Error - Document not found!')
      console.error('[home.vue] Query that caused 404:', error.data?.query)
    }
    console.error('[home.vue] Error details:', JSON.stringify(error, null, 2))
    console.error('[home.vue] Error stack:', error.stack)
    return []
  }
})

const tags = computed(() => allTags.value || ['è©¦é¨“æƒ…å ±', 'åˆæ ¼ä½“é¨“è¨˜', 'ç‹¬å­¦', 'ãƒ†ã‚­ã‚¹ãƒˆ', 'ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢', 'èª¿å‰¤è–¬å±€'])

const formatDate = (date: string | undefined) => {
  if (!date) return ''
  try {
    const d = new Date(date)
    return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`
  } catch {
    return ''
  }
}
</script>

<style scoped>
.hero-button:hover {
  background-color: var(--brand) !important;
  color: white !important;
}
</style>
